# 36. Service.md

## Draft 

* Service == 다른 컴포넌트들과의 커뮤니케이션을 위한 친구.
* internal, external 커뮤니케이션을 forwarding, load balancing등 여러 역할을 수행 가능.
* 이때 selector ~ label mapping을 통해, pod이 1개던, N개던, 여러 Node에 퍼져있던 상관없이 동일하게 수행 가능.
* type == node port, load balacing, etc
* 예제 : external 커뮤니케이션을 하고 싶다 (node>service>pod? 구조가 어떻게 되는지 재확인)
    * 이때 알아야 할 것은 node port, service port, pod  port
* how to create?
    * pod, rs, deployment과 같이 4가지 항목으로 구성(apiVersion, kind, metadata, spec)
    * 젤 중요한 것은 spec이며, 
        * type 
        * other
* 강의 예제에서는, node>pod과 커뮤니케이션을, 서비스를 이용해 해주는 이야기를 하고 있다.

## TL;DR

🎯 **Kubernetes 서비스란 무엇인가요?**

> 애플리케이션 내부 및 외부 구성 요소 간 통신용

- 쿠버네티스 서비스는 애플리케이션의 내부 및 외부 구성 요소 간의 통신을 가능하게 합니다.
- 이를 통해 여러 애플리케이션 및 사용자 간의 상호 연결이 가능합니다.
- 예를 들어, 프론트엔드 로드를 처리하는 그룹, 백엔드 프로세스를 실행하는 그룹 및 외부 데이터 소스에 연결하는 그룹과 같은 여러 그룹의 Pod가 있는 애플리케이션에서 서비스는 이러한 그룹 간의 연결을 가능하게 합니다.

🌐 **외부 통신을 위한 Kubernetes 서비스**

- 외부 사용자는 쿠버네티스 노드에 배포된 웹 애플리케이션에 어떻게 액세스할 수 있을까요?
- 서비스는 노드에서 특정 포트를 수신하고 해당 포트로 요청을 전달하여 웹 애플리케이션을 실행하는 Pod로 요청을 전달합니다.
- NodePort 서비스는 이러한 노드에서 포트를 수신하고 Pod로 요청을 전달하는 유형의 서비스입니다.

🛠️ **서비스 유형**

- 노드 포트 서비스(NodePort): 노드에서 포트를 수신하고 Pod로 요청을 전달합니다.
- 클러스터 IP 서비스(ClusterIP): 클러스터 내 다른 서비스 간의 통신을 가능하게 합니다.
- 로드 밸런서 서비스(LoadBalancer): 지원되는 클라우드 제공업체에서 애플리케이션을 위한 로드 밸런서를 프로비저닝합니다.

    > 이때 selector ~ label mapping을 통해, pod이 1개던, N개던, 여러 Node에 퍼져있던 상관없이 동일하게 수행 가능.
    >
    > 부하 분산은 random 알고리즘 사용.


## How to create a Service object?

> pod, rs, deployment과 같이 4가지 항목으로 구성(apiVersion, kind, metadata, spec)
>
> 젤 중요한 것은 spec.


🔧 **Kubernetes 서비스 작성 방법**

1. **정의 파일 작성**
   - API 버전, 종류, 메타데이터 및 스펙 섹션을 포함한 정의 파일을 작성합니다.

2. **서비스 type 지정 in spec**
   - NodePort, ClusterIP, LoadBalancer

3. **NodePort Type의 경우,포트 정의**
   - 서비스에서 사용할 포트에 대한 정보를 입력합니다.
   - targetPort: Pod 내부의 웹 서버가 실행되는 포트를 지정합니다.
   - port: 서비스 객체 자체의 포트를 지정합니다.
   - nodePort: 노드 외부에서 웹 서버에 액세스하는 데 사용되는 노드의 포트를 지정합니다.

4. **라벨 및 셀렉터 지정**
   - Pod와 서비스를 연결하기 위해 라벨 및 셀렉터를 사용합니다.
   - Pod 정의 파일에서 라벨을 가져와 셀렉터 섹션에 배치합니다.

5. **서비스 생성**
   - kubectl create 명령을 사용하여 서비스를 생성합니다.
   - 서비스 정의 파일을 입력합니다.

6. **서비스 확인**
   - kubectl get services 명령을 사용하여 생성된 서비스를 확인합니다.
   - 서비스 유형, 클러스터 IP 및 매핑된 포트가 표시됩니다.

7. **웹 서비스 액세스**
   - 생성된 서비스를 사용하여 curl 또는 웹 브라우저를 통해 웹 서버에 액세스할 수 있습니다.

🔄 **다중 Pod 관리**

- 여러 Pod를 가진 상황에서는 라벨을 사용하여 해당 Pod를 서비스에 매핑합니다.
- 서비스가 라벨과 일치하는 Pod를 자동으로 선택하여 외부 요청을 전달합니다.
- 로드 밸런싱 알고리즘은 랜덤 알고리즘을 사용하여 여러 Pod 간의 부하를 분산합니다.

🚀 **자동화와 유연성**

- Pod 추가 또는 제거 시 자동으로 서비스가 업데이트되어 유연성과 적응성이 제공됩니다.
- 서비스 생성 후 추가 구성 변경이 필요하지 않습니다.

## Note

- node port의 경우 정해진 range 존재.

### 예제

🌐 외부 통신: 외부 사용자가 웹 애플리케이션에 접근하는 방법에 대해 설명합니다. Kubernetes 노드에 SSH 접속하여 파드의 웹페이지에 접근할 수 있지만, 이는 원하는 방식이 아닙니다. 대신, Kubernetes 노드의 IP를 통해 웹 서버에 접근하려고 합니다.

🖥️ 우리는 웹 애플리케이션이 실행되는 Pod를 배포했습니다. 외부 사용자로서 웹페이지에 어떻게 액세스할 수 있을까요? 먼저, 기존 설정을 살펴보겠습니다.

- Kubernetes 노드에는 IP 주소가 있습니다. 예를 들어, 192.168.1.2입니다.
- 제 노트북도 동일한 네트워크에 있으며 IP 주소는 192.168.1.10입니다.
- 내부 Pod 네트워크는 10.244.0.0 범위 내에 있습니다. Pod는 IP 주소 10.244.0.2를 가지고 있습니다.

🤔 명확히 별도의 네트워크에 있는 Pod 주소 10.244.0.2에 대한 핑 또는 액세스가 불가능합니다. 그렇다면 웹페이지를 볼 수 있는 옵션은 무엇일까요?

- 첫 번째로, 노드에서 Kubernetes 노드로 SSH하면 curl을 통해 Pod의 웹페이지에 액세스할 수 있습니다.
- 노드에 GUI가 있다면 브라우저를 열어 http://10.244.0.2 주소로 웹페이지를 볼 수 있습니다.

🔌 그러나 이것은 쿠버네티스 노드 내부에서이며, 실제로 원하는 것은 아닙니다. 제 노트북에서 SSH를 사용하지 않고도 Kubernetes 노드의 IP에 액세스하여 웹 서버에 액세스하고 싶습니다. 이런 경우에 쿠버네티스 서비스가 필요합니다.

🎯 쿠버네티스 서비스는 노드에서 포트를 수신하여 해당 포트에서 웹 애플리케이션을 실행하는 Pod의 포트로 요청을 전달하는 객체입니다.

📡 노드 포트 서비스는 노드에서 포트를 수신하고 Pod로 요청을 전달하기 때문에

 이를 NodePort 서비스라고 합니다.

🔄 그 외에도 클러스터 내 다른 서비스 간 통신을 가능하게 하는 ClusterIP, 지원되는 클라우드 제공업체에서 애플리케이션을 위한 로드 밸런서를 프로비저닝하는 LoadBalancer와 같은 유형의 서비스가 있습니다.




## Draft from Copilot

1. 🌐 Kubernetes 서비스: Kubernetes 서비스는 애플리케이션 내부 및 외부의 다양한 컴포넌트 간 통신을 가능하게 합니다. 서비스는 프론트엔드, 백엔드, 외부 데이터 소스 등 다양한 파드 그룹 간 연결성을 제공합니다.

2. 🎯 서비스의 사용 사례: 서비스는 프론트엔드 애플리케이션을 최종 사용자에게 제공하고, 백엔드와 프론트엔드 파드 간 통신을 돕고, 외부 데이터 소스와의 연결성을 설정하는 데 도움이 됩니다.

3. 🌐 외부 통신: 외부 사용자가 웹 애플리케이션에 접근하는 방법에 대해 설명합니다. Kubernetes 노드에 SSH 접속하여 파드의 웹페이지에 접근할 수 있지만, 이는 원하는 방식이 아닙니다. 대신, Kubernetes 노드의 IP를 통해 웹 서버에 접근하려고 합니다.

4. 🚀 Kubernetes 서비스의 역할: Kubernetes 서비스는 노드에서 포트를 수신하고 해당 포트에 대한 요청을 웹 애플리케이션을 실행하는 파드의 포트로 전달하는 역할을 합니다. 이러한 유형의 서비스를 NodePort 서비스라고 합니다.

5. 🎛️ 서비스 유형: NodePort, ClusterIP, LoadBalancer 등 세 가지 유형의 서비스가 있습니다. 

6. 📝 서비스 생성: 서비스를 생성하기 위해 정의 파일을 사용합니다. 정의 파일에는 API 버전, 종류, 메타데이터, spec 섹션이 포함됩니다.

7. 🎯 서비스와 파드 연결: 서비스 정의 파일에는 서비스를 파드에 연결하는 데 필요한 레이블과 선택자가 포함되어 있습니다.

8. 🔄 로드 밸런싱: 서비스는 여러 파드에 대한 요청을 자동으로 분산시키는 내장 로드 밸런서 역할을 합니다.

9. 🌐 다중 노드에서의 파드: 서비스는 클러스터 내의 모든 노드에 걸쳐 생성되며, 모든 노드에서 동일한 노드 포트를 대상 포트에 매핑합니다. 이를 통해 클러스터 내의 어떤 노드의 IP를 사용하여도 애플리케이션에 접근할 수 있습니다.

